%------------------------------------------------------------------------------
% Document setup
%------------------------------------------------------------------------------
\documentclass[american, twoside]{article}
%-------------------------------------------------------------------------
% Packages
%-------------------------------------------------------------------------
% Ability to reference the number of pages in document
\usepackage{lastpage}
% Nice equations
\usepackage{mathtools}
% Skip a line between paragraphs
\usepackage[skip=10pt plus1pt, indent=40pt]{parskip}
% Alter the margins, twoside tells it to alternate left/right margins on even/odd pages for
% two-sided printing
\usepackage[twoside, letterpaper, lmargin=0.75in, rmargin=1.0in]{geometry}
% Fancy Headers/Footers
\usepackage{fancyhdr}
% To undo centering in noteworthy command
\usepackage{ragged2e}
% Adjust table of contents formatting
\usepackage{tocloft}
% Provide hypertext links
\usepackage{hyperref}
% Custom datetime formatting
\usepackage{datetime2}
\usepackage{csquotes}
% Language localization
\usepackage[american]{babel}
% Boxes around stuff (Abstract and ToC)
\usepackage[most]{tcolorbox}
% Make some micro-typographical corrections to improve appearance
\usepackage{microtype}
% Reference management
\usepackage[sorting=nty, backref=true, backend=biber, hyperref=true, sortcites=true]{biblatex}
% Pretty plots
\usepackage{pgfplots}
% Figure placement
\usepackage{float}
%-------------------------------------------------------------------------
% End Packages
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Custom date format
%-------------------------------------------------------------------------
\DTMnewdatestyle{strunkdate}{%
  \renewcommand*{\DTMdisplaydate}[4]{\number##3\ \DTMenglishmonthname{##2} ##1}
  \renewcommand*{\DTMDisplaydate}{\DTMdisplaydate}}
\AtBeginDocument{\DTMsetdatestyle{strunkdate}}
%-------------------------------------------------------------------------
% End Custom date format
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Article meta-data
%-------------------------------------------------------------------------
\title{\Huge Filtering Seismic Timeseries Data in Passive-source Seismic-Processing (PsSp)\\
\large Implementation details of the filters provided for isolating seismic signals}
\author{Alexander R. Blanchette\thanks{arbCoding@gmail.com}}
\date{\Today}
\addbibresource{filters.bib}
%-------------------------------------------------------------------------
% End Article meta-data
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Draft formatting options
%-------------------------------------------------------------------------
% These can be commented out to get a finalized version
% Place line numbers in the left-side margin
%\usepackage[left]{lineno}
%\linenumbers
% Double-spacing
%\usepackage{setspace}
%\doublespacing
%-------------------------------------------------------------------------
% End Draft formatting options
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Miscellaneous Formatting
%-------------------------------------------------------------------------
\fancyhf{} % clear existing header/footer entries
% Place Page X of Y on outer-edge of footer
\fancyfoot[RO, LE]{Page \thepage \hspace{1pt} of \pageref{LastPage}}
\fancyhead{} % clear all header fields
\fancyhead[RO, LE]{\textbf{Filtering Seismic Timeseries Data}}
\fancyhead[C]{Blanchette}
\fancyhead[LO, RE]{2023}
% Not so ugly anymore!
\hypersetup{colorlinks=true, linkcolor=black, citecolor=blue, filecolor=magenta, urlcolor=blue, pdftitle={Filtering Seismic Timeseries Data}, pdfpagemode=FullScreen}
\urlstyle{same}
% Pgfplot compatibility
\pgfplotsset{compat=1.18}
%-------------------------------------------------------------------------
% End Miscellaneous Formatting
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Functions to build list of equations
%-------------------------------------------------------------------------
% define list of equations
\newcommand{\listequationsname}{\Large{Equations}}
\newlistof{myequations}{equ}{\listequationsname}
\newcommand{\myequations}[1]{
   \addcontentsline{equ}{myequations}{\protect\numberline{\theequation}#1}
}
\setlength{\cftmyequationsnumwidth}{2.3em}
\setlength{\cftmyequationsindent}{1.5em}

% command to label, reference, and include 'noteworthy' equation in list of equations
\newcommand{\noteworthy}[2]{
    \begin{align} \label{#2} \ensuremath{#1} \end{align} 
    \myequations{#2} \centering \small #2 \normalsize \justify
}
%-------------------------------------------------------------------------
% End Functions to build list of equations
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Plotting functions
%-------------------------------------------------------------------------
% Gaussian
\pgfmathdeclarefunction{gauss}{2}{%
    \pgfmathparse{1/(#2*sqrt(2*pi))*exp(-((x-#1)^2)/(2*#2^2))}%
}
% Sinc function
\pgfmathdeclarefunction{sinc}{1}{%
    \pgfmathparse{sin(deg(#1))/(#1)}%
}
% Ricker wavelet
\pgfmathdeclarefunction{ricker}{2}{%
    % Normalized
    %\pgfmathparse{(2/(sqrt(3*#2)*pi^(1/4)))*(1-((#1/#2)^2))*e^(-(#1^2)/(2*(#2^2)))}%
    % Unnormalized (better for me)
    \pgfmathparse{(1-((#1/#2)^2))*e^(-(#1^2)/(2*(#2^2)))}%
}
% Wave-packet function
\pgfmathdeclarefunction{wavepack}{3}{%
    \pgfmathparse{cos(deg(#1*2*pi/#2))*e^(-((#1*2*pi)^2)/(#3^2))}
}
%-------------------------------------------------------------------------
% End Plotting functions
%-------------------------------------------------------------------------

%------------------------------------------------------------------------------
% End Document setup
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Article Content
%------------------------------------------------------------------------------
\begin{document}
\maketitle
\pagestyle{fancy}
%-------------------------------------------------------------------------
% Foreword
%-------------------------------------------------------------------------
\scriptsize The goal of this document is to be as useful and accessible as possible. Therefore, it is a \textit{living document}. By that I mean
that it will change and grow over time in order to ensure the quality of the content. As such, I don't ever truly plan on it being
\textit{finished}.
\normalsize
%-------------------------------------------------------------------------
% End Foreword
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Abstract and Plain Language Summary
%-------------------------------------------------------------------------
\begin{tcolorbox}[enhanced]
    % Don't number
    \section*{Abstract} \label{Abstract}
    % Add to the ToC even though not numbered
    \addcontentsline{toc}{section}{\nameref{Abstract}}
    Seismic data---whether it is ground motion (displacement), velocity, or acceleration---is recorded as a function of time (timeseries). Seismic timeseries
    recordings contain information from a plethora of sources---natural and anthropogenic. Typically, an analysis task is focused on processing/analyzing
    signals from a specific target \textit{source}\footnote{\textit{Source} is being used in the generic sense here; it could refer to the nucleation point of the seismic
    signals (earthquakes, explosions, etc.) or to structural sources (reflections, refractions, conversions).}. Generally, seismometers record and are sensitive
    to a frequency range that is significantly larger than that which any given analytical method/goal requires. Filtering is a critically important tool for
    isolating signals of interest. In this document I give a brief overview of timeseries filtering in general and provide the specific details of the filters
    implemented in Passive-source Seismic-processing (PsSp).
    \section*{Plain Language Summary} \label{PlainSummary}
    Filters are an important step in preparing seismic data to be analyzed. In this document I will hint at some of the basic theory of seismic filtering
    with most of the focus being placed on the specific filters implemented in PsSp. This is intended to serve as a basic guide on the what/how of filtering seismic data without going through
    any explicit mathematical derivations; instead I hope this will provide a more intuitive understanding to the reader.
\end{tcolorbox}
%-------------------------------------------------------------------------
% End Abstract and Plain Language Summary
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% ToC
%-------------------------------------------------------------------------
\newpage
\begin{tcolorbox}[enhanced]
    \renewcommand\cftsecfont{\large}
    \renewcommand\cftsecpagefont{\small}
    \tableofcontents
\end{tcolorbox}
%-------------------------------------------------------------------------
% End ToC
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% List of Figures
%-------------------------------------------------------------------------
\begin{tcolorbox}[enhanced]
    \renewcommand{\listfigurename}{Figures}
    \listoffigures
\end{tcolorbox}
%-------------------------------------------------------------------------
% End List of Figures
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% List of Tables
%-------------------------------------------------------------------------
% Currently no tables so not needed
%\begin{tcolorbox}[enhanced]
%    \renewcommand{\listtablename}{Tables}
%    \listoftables
%\end{tcolorbox}
%-------------------------------------------------------------------------
% End List of Tables
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% List of Equations
%-------------------------------------------------------------------------
\begin{tcolorbox}[enhanced]
    \listofmyequations
\end{tcolorbox}
%-------------------------------------------------------------------------
% End List of Equations
%-------------------------------------------------------------------------
\newpage

%-------------------------------------------------------------------------
% Introduction
%-------------------------------------------------------------------------
\section{Introduction} \label{Introduction}
Filtering of time-dependent recordings (timeseries data) is a task common among a wide range of different scientific/engineering disciplines.
While great advances have been made to analyze as much of the seismic timeseries as possible---such as the extraction of approximate
Green's functions from the ambient seismic noise field---virtually all seismic analysis first requires the seismic timeseries to
be filtered in order to isolate the portion of the recorded data that is most compatible with the intended analysis. In the fairly
distant past this was less important due to the limitations of: 1) the available seismographic instruments, and 2) the available
computational infrastructure. At present, relatively inexpensive seismometers can record broadband seismic timeseries with the flat-sensitivity
range of a high-quality instrument being between a period of 1000 seconds (s) at the low end (a frequency of 0.001 Hz) up to a high
of 100 Hz. Such a large dynamic range of frequencies---containing signals from numerous stationary and non-stationary sources---results in a
rather complicated timeseries. This excess information convolutes the analysis of the signal(s) of interest.
Filtering is the solution to this problem; it allows the analyst to isolate the signal(s) of interest by removing the \textit{noise}\footnote{\textit{Noise} is a bit of a misunderstood term in
seismology, especially with the advances in the last few decades in ambient noise seismology. The word 'noise' is used here to mean 'any
signal that is not of interest for a specific analysis' and does not provide any suggestion to the source of the noise.} from the
recorded timeseries. Fortunately---thanks to the many technological advancements over the last few decades---personal computers are sufficiently
capable of handling most modern seismic workflows (all except particularly large or high throughput workflows that require more specialized
computing infrastructure).

Filtering is a tremendously wide topic of study itself, with a rich history across many otherwise disparate fields of study, well
beyond the scope of this simple document. Therefore, I will restrict myself to---at most---provide a brief discussion
on the fundamentals of filtering, while leaving many of the details up for the intrepid reader to research on their own. Afterward,
I will provide a detailed description of the implementation of filters specific to \href{https://github.com/arbCoding/PsSp}{PsSp}.
This is not meant to provide a detailed derivation from first principles of the filters employed, but is instead intended to serve as
a pragmatic guide on their internal implementation. This is intended as much as a guide to any reader as it is to myself.
%-------------------------------------------------------------------------
% End Introduction
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% Background
%-------------------------------------------------------------------------
\section{Background} \label{Background}
Filtering of timeseries data is necessary across numerous disciplines (e.g. seismology, electrical engineering, audio engineering, etc.). Due to its prevalence
across a diverse range of disciplines, it has been studied extensively over time---with many of the major theoretical advances having been discovered
more than 100 years ago (Joseph Fourier published on his series expansion in 1822\autocite{fourier1822theorie}). In fact, the Butterworth filters employed here were first published
by Stephan Butterworth in 1930\autocite{butterworth1930theory}. Of course, there has been significant progress since, both theoretical and practical. While much could be---and has been---written
on the history of filtering signals, I think that it is sufficient here to simply say that it is a quite mature field of study and leave the historical developments
to the reader to research on their own, if they so desire.

%--------------------------------------------------------------------
% Mathematical Background
%--------------------------------------------------------------------
\subsection{Mathematical Background} \label{Background:Math}
While I do intend for this document to focus more on the development of the reader's intuitive understanding of the filtering process, it would be a significant
disservice to totally forgoe all mathemtical formalism. In fact, the equations themselves provide a great deal of insight into inner workings of the filters.
In order to provide a sufficiently comprehensive introduction to the application of filters I will need to first introduce a few mathematical concepts. In particular,
I need to discuss how it is that we take data that is measured over time and \textit{transform}\footnote{\textit{Transform} is commonly used in mathematics to refer to
a linear change of basis. That is, to change the meaning of the dependent-variable in a well-behaved and reversable manner.} it to the frequency (spectral) domain (via the \textit{Fourier Transform})
and then back to the time domain (via the \textit{Inverse Fourier Transform}). I must also discuss how we take a filter that is defined in the Lapace (Complex-Frequency)
domain and apply it to a signal in the (non-complex) frequency domain.

\subsubsection{The Temporal (Time) Domain} \label{Background:Math:Temporal}
Observations are always made as a function of time. Whether the process is constant or dynamic, the very nature of measurement is time-dependent itself. We can, at best, make the
rather artifical assumption of constancy and pretend that time doesn't exist---but we can never truly remove the temporal component from our measurements. Seismographic stations
record ground motion as a function of time. The distinction between measurements of displacement, velocity, and acceleration is simply a matter of differentiation $x\rightarrow v\rightarrow a$
or integration $a\rightarrow v \rightarrow x$. The distinction between ground motion and the actual instrumental measurement is related the internal instrument response\footnote{Instrument
response removal can be thought of as a form of filtering, but it will be a topic of a separate document.}.

\begin{center}
    \begin{figure}[ht]
        \label{figure:1}
        \begin{tikzpicture}
            \begin{axis}[
                width=0.95\textwidth,
                height=5cm,
                title={},
                axis lines=left,
                xlabel = \(t\hspace{1pt}(s)\),
                ylabel = {\(f(t)\)},
                ymin = -1, ymax = 1.1,
                xmin = 0, xmax = 10,
            ]
                \addplot[
                    domain=0:10,
                    samples=500
                ]{wavepack(x-3, 0.25, 5)};
            \end{axis}
        \end{tikzpicture}
        \caption[Schematic timeseries]{A simple schematic timeseries.}
    \end{figure}
\end{center}

The timeseries recorded at a seismographic station is referred to as a seismogram. A rather simple example timeseries can be seen in figure \ref{figure:1}.
The timeseries in figure \ref{figure:1} shows a wave-packet with an \textit{arrival time}\footnote{\textit{Arrival time} is an ambiguous term with multiple
potential meanings. In this case I'm referring to the first deviation from zero amplitude (often referred to as the \textit{first break}.)} of approximately one second
and is centered at three seconds. For the sake of completeness: the waveform plotted in figure \ref{figure:1} was generated using equation \ref{Schematic Timeseries}.
It is simply a time-shifted cosine function multiplied by a two-sided exponential attenuation function.

\noteworthy{f(t) = cos\left(8\pi(t-3)\right)e^{-\left(\frac{2\pi(t-3)^{2}}{9}\right)}}{Schematic Timeseries}

In this case we can determine at least one frequency purely by visual inspection. The cosine function is $2\pi$-periodic, meaning that $cos(t)$ has a frequency of
$\frac{1}{2\pi}$ Hz. In this particular case I've chosen to have a frequency greater than one (it is exactly 4 Hz). Are there signals of other frequencies contained
in equation \ref{Schematic Timeseries}? Yes, in fact it contains a range of frequencies---an observation that is not immediately obvious when written as a function of time.
I'll return to the frequencies hidden in this example timeseries once I've introduced the Fourier Transform of a function.

\subsubsection{The Spectral (Frequency) Domain} \label{Background:Math:Spectral}


\subsubsection{The Laplace (Complex-Frequency) Domain} \label{Background:Math:Laplace}
%--------------------------------------------------------------------
% End Mathematical Background
%--------------------------------------------------------------------
%-------------------------------------------------------------------------
% End Background
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% The Butterworth Filter
%-------------------------------------------------------------------------
\section{The Butterworth Filter} \label{Butterworth}
\subsection{Lowpass} \label{Butterworth:Lowpass}
Test equation reference for equation \ref{Butterworth Lowpass Filter}.
\noteworthy{H(s) = \frac{G_{0}}{B_{n}(a)}; a = \frac{s}{w_{c}}}{Butterworth Lowpass Filter}
\noteworthy{B_{n}(s) = \sum_{k = 0}^{n} a_{k}s^{k}}{Normalized Butterworth Polynomial}
\noteworthy{a_{k + 1} = a_{k}\frac{cos\left(k\gamma\right)}{sin((k + 1)\gamma)}; a_{0} = 1; \gamma = \frac{\pi}{2n}; a_{k} = a_{n - k}}{Normalized Butterworth Polynomial Coefficients}

\subsection{Highpass} \label{Butterworth:Highpass}

\subsection{Bandpass} \label{Butterworth:Bandpass}
\subsection{Bandreject} \label{Butterworth:Bandreject}
%-------------------------------------------------------------------------
% End The Butterworth Filter
%-------------------------------------------------------------------------

%-------------------------------------------------------------------------
% References
%-------------------------------------------------------------------------
% Always want the references to start on a new page
\newpage
\printbibliography[heading=bibintoc]
%-------------------------------------------------------------------------
% End References
%-------------------------------------------------------------------------

\end{document}
%------------------------------------------------------------------------------
% End Article Content
%------------------------------------------------------------------------------